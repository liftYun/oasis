stages: [notify]

# ê³µí†µ í…œí”Œë¦¿
.notify_template:
  stage: notify
  image: alpine:3.20
  before_script:
    - apk add --no-cache curl jq
  script:
    # MR ìƒì„¸ ì¡°íšŒ (ë¦¬ë·°ì–´/ë¼ë²¨ í¬í•¨)
    - >
      MR_INFO=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN"
      "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID")
    - TITLE=$(echo "$MR_INFO" | jq -r '.title')
    - URL=$(echo "$MR_INFO" | jq -r '.web_url')
    - SRC=$(echo "$MR_INFO" | jq -r '.source_branch')
    - TGT=$(echo "$MR_INFO" | jq -r '.target_branch')
    - REVIEWERS=$(echo "$MR_INFO" | jq -r '[.reviewers[]?.username] | map("@"+.) | join(", ") // "ì—†ìŒ"')
    - LABELS=$(echo "$MR_INFO" | jq -r '[.labels[]?] | join(", ") // "ì—†ìŒ"')
    - AUTHOR="$GITLAB_USER_NAME (@$GITLAB_USER_LOGIN)"
    - >
      curl -s -X POST -H 'Content-Type: application/json'
      -d "{\"attachments\":[{\"pretext\":\"ğŸ§© Merge Request ì•Œë¦¼\",
      \"title\":\"!$CI_MERGE_REQUEST_IID $TITLE\",
      \"title_link\":\"$URL\",
      \"text\":\"$AUTHOR ë‹˜ì´ MRì„ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.\",
      \"fields\":[
        {\"title\":\"ë¦¬ë·°ì–´\",\"value\":\"$REVIEWERS\",\"short\":true},
        {\"title\":\"ë¸Œëœì¹˜\",\"value\":\"$SRC â†’ $TGT\",\"short\":true},
        {\"title\":\"ë¼ë²¨\",\"value\":\"$LABELS\",\"short\":true}
      ]}]}\""
      "$MATTERMOST_WEBHOOK"

# back í´ë” ë³€ê²½ ì‹œ (MR ì´ë²¤íŠ¸)
notify:back:
  extends: .notify_template
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - back/**

# front í´ë” ë³€ê²½ ì‹œ (MR ì´ë²¤íŠ¸)
notify:front:
  extends: .notify_template
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - front/**

# ë³‘í•©(íƒ€ê¹ƒ ë¸Œëœì¹˜ push) ì‹œ ì•Œë¦¼ ì¶”ê°€ ì˜ˆì‹œ - ì„ íƒ
notify:merged:
  extends: .notify_template
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
